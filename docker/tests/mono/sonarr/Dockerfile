FROM ubuntu:jammy

ENV DEBIAN_FRONTEND noninteractive
ARG MONO_VERSION=8.0
ARG MONO_URL=stable-focal/snapshots/$MONO_VERSION

RUN apt-get update && apt install -y \
        ca-certificates gnupg \
    && gpg --homedir /tmp --no-default-keyring --keyring /usr/share/keyrings/mono-official-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF && \
    echo "deb [signed-by=/usr/share/keyrings/mono-official-archive-keyring.gpg] https://download.mono-project.com/repo/ubuntu $MONO_URL main" > /etc/apt/sources.list.d/mono-official-stable.list && \
    apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 2009837CBFFD68F45BC180471F4F90DE2A9B4BF8 && \
    echo "deb http://apt.sonarr.tv/ubuntu jammy main" > /etc/apt/sources.list.d/sonarr.list && \
    apt-get update && apt-get install -y \ 
        tofrodos tzdata \
        sonarr \
        sqlite3 mediainfo \
        && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \ 
        libmono-system-runtime4.0-cil \
        libmono-system-net-http4.0-cil \
        && rm -rf /var/lib/apt/lists/*

COPY startup.sh /startup.sh
RUN  fromdos /startup.sh

WORKDIR /data/
VOLUME ["/data/_tests_linux", "/data/_output_linux", "/data/_tests_results"]

RUN groupadd sonarrtst -g 4020 && useradd sonarrtst -u 4021 -g 4020 -m -s /bin/bash
USER sonarrtst

CMD bash /startup.sh

